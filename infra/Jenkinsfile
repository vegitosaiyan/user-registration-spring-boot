pipeline{
    agent any

    tools{
        maven 'Maven-3.9'
        jdk 'Java-21'
    }

    environment{
        // Docker Hub credentials
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_IMAGE_NAME = 'vegitosaiyan/user-registration'
        DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'
    }


    stages{
        stage('Checkout'){
            steps{
               echo 'Checking out code from Github'
               checkout scm
            }
        }

        stage('Build'){
            steps{
                echo 'Building the project'
                sh 'mvn clean compile'
            }
        }

        stage('Build JAR'){
            steps{
                echo 'Packaging application'
                sh 'mvn package -DskipTests'
            }
        }

        stage('Build Docker Image'){
            steps{
                echo 'Building Docker Image'
                script{
                    dockerImage = docker.build("${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}")
                    dockerImage.tag('latest')
                }
            }
        }

        stage('Push to registry'){
            steps{
                echo 'Pushing Docker image to registry'
                script{
                    docker.withRegistry("https://${DOCKER_REGISTRY}",DOCKER_CREDENTIALS_ID){
                        dockerImage.push("${BUILD_NUMBER}")
                        dockerImage.push('latest')
                    }
                }
            }
        }

        stage('Cleanup'){
            steps{
                echo 'Cleaning up local Docker Images'
                sh """
                    docker rmi ${DOCKER_IMAGE_NAME}:${BUILD_NUMBER} || true
                    docker rmi ${DOCKER_IMAGE_NAME}:latest || true
                """
            }
        }

        stage('Deploy to Kubernetes'){
            steps{
                echo 'Deploying to Kubernetes cluster'
                script {
                    sh"""
                        sed -i 's|image: .*|image:${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}'|g' infra/k8s/app-deployment.yaml
                    """
                    //Apply Kubernetes Manifests
                    sh """
                        kubectl apply -f infra/k8s/
                    """

                    //Waiting for roll-out to complete
                    sh """
                        kubectl rollout status deployment/user-registration-app -n user-registration --timeout=5m
                    """
                }
            }
        }
    }//end of stages

post{
    success{
        echo 'Build successful'
        cleanWs()
    }
    failure{
        echo 'Build failed'
        cleanWs()
    }
}//end of post
}//end of pipeline